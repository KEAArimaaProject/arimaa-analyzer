@using ArimaaAnalyzer.Maui.Services.Arimaa
@inject ArimaaGameService Game

<div class="board">
    @for (var r = 0; r < 8; r++)
    {
        <div class="rank">
            @for (var c = 0; c < 8; c++)
            {
                var pos = new Position(r, c);
                var piece = Game.State.GetPiece(pos);
                // Arimaa traps: only C3, F3, C6, F6 should be dark.
                // With 0-based indices, columns A..H -> 0..7, rows top(8)..bottom(1) -> 0..7
                // So C3 -> (row 5, col 2), F3 -> (5,5), C6 -> (2,2), F6 -> (2,5)
                var isDark = (r == 2 || r == 5) && (c == 2 || c == 5);
                var isSelected = Game.Selected is { } s && s == pos;
                <div class="square @(isDark ? "dark" : "light") @(isSelected ? "selected" : null)"
                     @onclick="() => OnSquareClick(pos)">
                    @if (piece is not null)
                    {
                        <img src="@($"pieces/{piece.SvgFileName}")" alt="@($"{piece.Side} {piece.Type}")" />
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    private void OnSquareClick(Position pos)
    {
        var piece = Game.State.GetPiece(pos);
        if (Game.Selected is null)
        {
            if (piece is not null)
            {
                Game.Select(pos);
            }
            return;
        }

        // If clicking the selected square, clear selection
        if (Game.Selected == pos)
        {
            Game.ClearSelection();
            return;
        }

        // Try move, otherwise select new piece if there is one
        if (!Game.TryMoveTo(pos) && piece is not null)
        {
            Game.Select(pos);
        }
    }
}
