@using ArimaaAnalyzer.Maui.Services.Arimaa
@using Microsoft.AspNetCore.Components
@implements IDisposable

<div class="gtc-container">
    @if (Game?.CurrentNode is null)
    {
        <div class="gtc-empty">No active node</div>
    }
    else if (Game.CurrentNode.Children is { Count: > 0 } children)
    {
        @if (!string.IsNullOrWhiteSpace(Game.PendingMoveText))
        {
            <div class="gtc-pending" title="Pending moves that can be reset or committed">
                Pending: @Game.PendingMoveText
            </div>
        }
        @foreach (var child in children)
        {
            <button class="gtc-item" title="Go to this variation"
                    @onclick="() => Game.Load(child)">
                @string.Join(" ", child.Moves.ToArray())
            </button>
        }
    }
    else
    {
        <div class="gtc-empty">No children</div>
        @if (!string.IsNullOrWhiteSpace(Game.PendingMoveText))
        {
            <div class="gtc-pending" title="Pending moves that can be reset or committed">
                Pending: @Game.PendingMoveText
            </div>
        }
    }
</div>

@code {
    [Parameter]
    [EditorRequired]
    public ArimaaGameService Game { get; set; } = default!;

    protected override void OnInitialized()
    {
        if (Game is not null)
        {
            Game.CurrentNodeChanged += OnCurrentNodeChanged;
            Game.StateChanged += OnStateChanged;
        }
    }

    private void OnCurrentNodeChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        if (Game is not null)
        {
            Game.CurrentNodeChanged -= OnCurrentNodeChanged;
            Game.StateChanged -= OnStateChanged;
        }
    }
}
